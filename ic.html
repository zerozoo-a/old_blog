---
layout: default
title: convert image to webp
---
<div>
    <h1>Convert image to webp format</h1>
    <div>
      <input 
      type="file" 
      multiple
      accept="image/*"
      onchange="convertFileToWebp(event)"
      >
    </div>
    <div id="previews"></div>
    <canvas 
    id="webp-canvas"></canvas>
    <button onclick="handle()">hi</button>
</div>


<script>
  const handle = () => {console.log('hhhh')}
    function drawImageProp (ctx, img, x, y, w, h, offsetX, offsetY) {
      if (arguments.length === 2) {
          x = y = 0;
          w = ctx.canvas.width;
          h = ctx.canvas.height;
      }

      // default offset is center
      offsetX = typeof offsetX === "number" ? offsetX : 0.5;
      offsetY = typeof offsetY === "number" ? offsetY : 0.5;

      // keep bounds [0.0, 1.0]
      if (offsetX < 0) offsetX = 0;
      if (offsetY < 0) offsetY = 0;
      if (offsetX > 1) offsetX = 1;
      if (offsetY > 1) offsetY = 1;

      var iw = img.width,
          ih = img.height,
          r = Math.min(w / iw, h / ih),
          nw = iw * r,   // new prop. width
          nh = ih * r,   // new prop. height
          cx, cy, cw, ch, ar = 1;

          // decide which gap to fill    
          if (nw < w) ar = w / nw;                             
          if (Math.abs(ar - 1) < 1e-14 && nh < h) ar = h / nh;  // updated
          nw *= ar;
          nh *= ar;

          // calc source rectangle
          cw = iw / (nw / w);
          ch = ih / (nh / h);

          cx = (iw - cw) * offsetX;
          cy = (ih - ch) * offsetY;

          // make sure source rectangle is valid
          if (cx < 0) cx = 0;
          if (cy < 0) cy = 0;
          if (cw > iw) cw = iw;
          if (ch > ih) ch = ih;

          // fill image in dest. rectangle
          ctx.drawImage(img, cx, cy, cw, ch,  x, y, w, h);
    }

  /**
   * 
   * */
  const convertFileToWebp = (event) => {
    const loadImage = (file) => new Promise((res,rej) => {
      const image = new Image();
      image.addEventListener("load",()=>{
        res({file,image});
      });
      image.src = URL.createObjectURL(file);
    })

    const drawImage = ({file, image})=> new Promise((res,rej) => {
      const canvas = document.querySelector('#webp-canvas');
      const context = canvas.getContext("2d");

      drawImageProp(context, image);
      canvas.toBlob((blob) => res({file, imageURL: URL.createObjectURL(blob)}),"image/webp");
    });

    const scaleImage = ({file, imageURL}) => new Promise((res,rej)=>{
      const image = new Image();
      image.setAttribute("src", imageURL);
      image.addEventListener("load",()=>res({file, imageURL, image}));
    })

    const downloadImage = ({file, imageURL, image}) => new Promise((res, rej) => {
      const imageLink = document.createElement("a");
      imageLink.setAttribute("href", imageURL);
      imageLink.setAttribute("download",`${file.name}.webp`)
      imageLink.appendChild(image);
    })

    console.log('evnet',event.target.files)

    for(const file of event.target.files) {
      loadImage(file).then(drawImage).then(downloadImage);
    }
  }


</script>


